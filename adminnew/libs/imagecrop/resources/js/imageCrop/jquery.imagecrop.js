(function(e){e.imageCrop=function(t,n){function L(t){i=e.extend(i,t)}function A(t){var n=e(t).offset();return[n.left,n.top]}function O(e){var t=A(s);var n=e.pageX-t[0],r=e.pageY-t[1];n=n<0?0:n>s.width()?s.width():n;r=r<0?0:r>s.height()?s.height():r;return[n,r]}function M(){return{selectionX:i.selectionPosition[0],selectionY:i.selectionPosition[1],selectionWidth:i.selectionWidth,selectionHeight:i.selectionHeight,selectionExists:function(){return N}}}function _(){u.css({display:N?"block":"none"})}function D(){a.css({cursor:i.allowSelect?"crosshair":"default"})}function P(){f.css({cursor:"default",display:N?"block":"none",left:i.selectionPosition[0],top:i.selectionPosition[1]}).width(i.selectionWidth).height(i.selectionHeight);l.css({backgroundPosition:-i.selectionPosition[0]-1+"px "+(-i.selectionPosition[1]-1)+"px",cursor:i.allowMove?"move":"default",display:N?"block":"none",left:i.selectionPosition[0]+1,top:i.selectionPosition[1]+1}).width(i.selectionWidth-2>0?i.selectionWidth-2:0).height(i.selectionHeight-2>0?i.selectionHeight-2:0)}function H(e){switch(e){case"fade-out":c.fadeOut("slow");h.fadeOut("slow");break;default:var t=N&&i.displaySize?"block":"none";h.css({cursor:"default",display:t,left:i.selectionPosition[0]+4,top:i.selectionPosition[1]+4}).html(i.selectionWidth+"x"+i.selectionHeight);c.css({cursor:"default",display:t,left:i.selectionPosition[0]+1,top:i.selectionPosition[1]+1}).width(h.width()+6).height(h.height()+6)}}function B(t){switch(t){case"hide-all":e(".image-crop-resize-handler").each(function(){e(this).css({display:"none"})});break;default:var n=N&&i.allowResize?"block":"none";p.css({cursor:"nw-resize",display:n,left:i.selectionPosition[0]-Math.round(p.width()/2),top:i.selectionPosition[1]-Math.round(p.height()/2)});d.css({cursor:"n-resize",display:n,left:i.selectionPosition[0]+Math.round(i.selectionWidth/2-v.width()/2)-1,top:i.selectionPosition[1]-Math.round(v.height()/2)});v.css({cursor:"ne-resize",display:n,left:i.selectionPosition[0]+i.selectionWidth-Math.round(v.width()/2)-1,top:i.selectionPosition[1]-Math.round(v.height()/2)});m.css({cursor:"w-resize",display:n,left:i.selectionPosition[0]-Math.round(v.width()/2),top:i.selectionPosition[1]+Math.round(i.selectionHeight/2-v.height()/2)-1});g.css({cursor:"e-resize",display:n,left:i.selectionPosition[0]+i.selectionWidth-Math.round(v.width()/2)-1,top:i.selectionPosition[1]+Math.round(i.selectionHeight/2-v.height()/2)-1});y.css({cursor:"sw-resize",display:n,left:i.selectionPosition[0]-Math.round(y.width()/2),top:i.selectionPosition[1]+i.selectionHeight-Math.round(y.height()/2)-1});b.css({cursor:"s-resize",display:n,left:i.selectionPosition[0]+Math.round(i.selectionWidth/2-w.width()/2)-1,top:i.selectionPosition[1]+i.selectionHeight-Math.round(w.height()/2)-1});w.css({cursor:"se-resize",display:n,left:i.selectionPosition[0]+i.selectionWidth-Math.round(w.width()/2)-1,top:i.selectionPosition[1]+i.selectionHeight-Math.round(w.height()/2)-1})}}function j(e){switch(e){case"focus":E.stop().animate({opacity:i.previewFadeOnFocus});break;case"blur":E.stop().animate({opacity:i.previewFadeOnBlur});break;case"hide":E.css({display:"none"});break;default:var t=N&&i.displayPreview?"block":"none";E.css({display:t,left:i.selectionPosition[0],top:i.selectionPosition[1]+i.selectionHeight+10});if(i.selectionWidth>i.selectionHeight){if(i.selectionWidth&&i.selectionHeight){S.width(Math.round(s.width()*i.previewBoundary/i.selectionWidth));S.height(Math.round(s.height()*S.width()/s.width()));E.width(i.previewBoundary).height(Math.round(i.selectionHeight*S.height()/s.height()))}}else{if(i.selectionWidth&&i.selectionHeight){S.height(Math.round(s.height()*i.previewBoundary/i.selectionHeight));S.width(Math.round(s.width()*S.height()/s.height()));E.width(Math.round(i.selectionWidth*S.width()/s.width())).height(i.previewBoundary)}}S.css({left:-Math.round(i.selectionPosition[0]*S.width()/s.width()),top:-Math.round(i.selectionPosition[1]*S.height()/s.height())})}}function F(e){a.css({cursor:e});f.css({cursor:e});l.css({cursor:e});c.css({cursor:e});h.css({cursor:e})}function I(e){switch(e){case"setSelection":_();P();B("hide-all");j("hide");break;case"pickSelection":B("hide-all");break;case"pickResizeHandler":H();B("hide-all");break;case"resizeSelection":P();H();B("hide-all");j();F("crosshair");break;case"moveSelection":P();B("hide-all");j();F("move");break;case"releaseSelection":D();_();P();H("fade-out");B();j();break;default:D();_();P();B();j()}}function q(t){t.preventDefault();t.stopPropagation();e(document).mousemove(z);e(document).mouseup(X);if(i.displayPreview){E.mouseenter(function(){j("focus")});E.mouseleave(function(){j("blur")})}N=true;i.selectionWidth=0;i.selectionHeight=0;k=O(t);i.selectionPosition[0]=k[0];i.selectionPosition[1]=k[1];I("setSelection")}function R(t){t.preventDefault();t.stopPropagation();e(document).mousemove(W);e(document).mouseup(X);var n=O(t);C[0]=n[0]-i.selectionPosition[0];C[1]=n[1]-i.selectionPosition[1];I("pickSelection")}function U(t){t.preventDefault();t.stopPropagation();switch(t.target.id){case"image-crop-nw-resize-handler":k[0]+=i.selectionWidth;k[1]+=i.selectionHeight;i.selectionPosition[0]=k[0]-i.selectionWidth;i.selectionPosition[1]=k[1]-i.selectionHeight;break;case"image-crop-n-resize-handler":k[1]+=i.selectionHeight;i.selectionPosition[1]=k[1]-i.selectionHeight;x=false;break;case"image-crop-ne-resize-handler":k[1]+=i.selectionHeight;i.selectionPosition[1]=k[1]-i.selectionHeight;break;case"image-crop-w-resize-handler":k[0]+=i.selectionWidth;i.selectionPosition[0]=k[0]-i.selectionWidth;T=false;break;case"image-crop-e-resize-handler":T=false;break;case"image-crop-sw-resize-handler":k[0]+=i.selectionWidth;i.selectionPosition[0]=k[0]-i.selectionWidth;break;case"image-crop-s-resize-handler":x=false;break}e(document).mousemove(z);e(document).mouseup(X);I("pickResizeHandler")}function z(e){e.preventDefault();e.stopPropagation();var t=O(e);var n=t[1]-k[1],r=t[0]-k[0];if(Math.abs(r)<i.minSize[0])r=r>=0?i.minSize[0]:-i.minSize[0];if(Math.abs(n)<i.minSize[1])n=n>=0?i.minSize[1]:-i.minSize[1];if(k[0]+r<0||k[0]+r>s.width())r=-r;if(k[1]+n<0||k[1]+n>s.height())n=-n;if(i.maxSize[0]>i.minSize[0]&&i.maxSize[1]>i.minSize[1]){if(Math.abs(r)>i.maxSize[0])r=r>=0?i.maxSize[0]:-i.maxSize[0];if(Math.abs(n)>i.maxSize[1])n=n>=0?i.maxSize[1]:-i.maxSize[1]}if(x)i.selectionWidth=r;if(T)i.selectionHeight=n;if(i.aspectRatio){if(r>0&&n>0||r<0&&n<0)if(x)n=Math.round(r/i.aspectRatio);else r=Math.round(n*i.aspectRatio);else if(x)n=-Math.round(r/i.aspectRatio);else r=-Math.round(n*i.aspectRatio);if(k[0]+r>s.width()){r=s.width()-k[0];n=n>0?Math.round(r/i.aspectRatio):-Math.round(r/i.aspectRatio)}if(k[1]+n<0){n=-k[1];r=r>0?-Math.round(n*i.aspectRatio):Math.round(n*i.aspectRatio)}if(k[1]+n>s.height()){n=s.height()-k[1];r=r>0?Math.round(n*i.aspectRatio):-Math.round(n*i.aspectRatio)}i.selectionWidth=r;i.selectionHeight=n}if(i.selectionWidth<0){i.selectionWidth=Math.abs(i.selectionWidth);i.selectionPosition[0]=k[0]-i.selectionWidth}else i.selectionPosition[0]=k[0];if(i.selectionHeight<0){i.selectionHeight=Math.abs(i.selectionHeight);i.selectionPosition[1]=k[1]-i.selectionHeight}else i.selectionPosition[1]=k[1];i.onChange(M());I("resizeSelection")}function W(e){e.preventDefault();e.stopPropagation();var t=O(e);if(t[0]-C[0]>0)if(t[0]-C[0]+i.selectionWidth<s.width())i.selectionPosition[0]=t[0]-C[0];else i.selectionPosition[0]=s.width()-i.selectionWidth;else i.selectionPosition[0]=0;if(t[1]-C[1]>0)if(t[1]-C[1]+i.selectionHeight<s.height())i.selectionPosition[1]=t[1]-C[1];else i.selectionPosition[1]=s.height()-i.selectionHeight;else i.selectionPosition[1]=0;i.onChange(M());I("moveSelection")}function X(t){t.preventDefault();t.stopPropagation();e(document).unbind("mousemove");e(document).unbind("mouseup");k[0]=i.selectionPosition[0];k[1]=i.selectionPosition[1];x=true;T=true;if(i.selectionWidth>i.minSelect[0]&&i.selectionHeight>i.minSelect[1])N=true;else N=false;i.onSelect(M());if(!N){E.unbind("mouseenter");E.unbind("mouseleave")}I("releaseSelection")}var r={allowMove:true,allowResize:true,allowSelect:true,aspectRatio:0,displayPreview:false,displaySizeHint:false,minSelect:[0,0],minSize:[0,0],maxSize:[0,0],outlineOpacity:.5,overlayOpacity:.5,previewBoundary:90,previewFadeOnBlur:1,previewFadeOnFocus:.35,selectionPosition:[0,0],selectionWidth:0,selectionHeight:0,onChange:function(){},onSelect:function(){}};var i=r;L(n);var s=e(t);var o=e("<div />").css({position:"relative"}).width(s.width()).height(s.height());s.wrap(o).css({position:"absolute"});var u=e('<div id="image-crop-overlay" />').css({opacity:i.overlayOpacity,position:"absolute"}).width(s.width()).height(s.height()).insertAfter(s);var a=e("<div />").css({backgroundColor:"#000000",opacity:0,position:"absolute"}).width(s.width()).height(s.height()).insertAfter(u);var f=e('<div id="image-crop-outline" />').css({opacity:i.outlineOpacity,position:"absolute"}).insertAfter(a);var l=e("<div />").css({background:"url("+s.attr("src")+") no-repeat",position:"absolute"}).insertAfter(f);var c=e('<div id="image-crop-size-hint-background" />').css({opacity:.35,position:"absolute"}).insertAfter(l);var h=e('<span id="image-crop-size-hint-foreground" />').css({position:"absolute"}).insertAfter(c);var p=e('<div class="image-crop-resize-handler" id="image-crop-nw-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var d=e('<div class="image-crop-resize-handler" id="image-crop-n-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var v=e('<div class="image-crop-resize-handler" id="image-crop-ne-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var m=e('<div class="image-crop-resize-handler" id="image-crop-w-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var g=e('<div class="image-crop-resize-handler" id="image-crop-e-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var y=e('<div class="image-crop-resize-handler" id="image-crop-sw-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var b=e('<div class="image-crop-resize-handler" id="image-crop-s-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var w=e('<div class="image-crop-resize-handler" id="image-crop-se-resize-handler" />').css({opacity:.5,position:"absolute"}).insertAfter(l);var E=e('<div id="image-crop-preview-holder" />').css({opacity:i.previewFadeOnBlur,overflow:"hidden",position:"absolute"}).insertAfter(f);var S=e('<img alt="Crop preview" id="image-crop-preview" />').css({position:"absolute"}).attr("src",s.attr("src")).appendTo(E);var x=true,T=true,N,C=[0,0],k=[0,0];if(i.selectionWidth>i.minSelect[0]&&i.selectionHeight>i.minSelect[1])N=true;else N=false;I();if(i.allowSelect)a.mousedown(q);if(i.allowMove)l.mousedown(R);if(i.allowResize)e("div.image-crop-resize-handler").mousedown(U);};e.fn.imageCrop=function(t){this.each(function(){var n=this,r=new Image;r.onload=function(){e.imageCrop(n,t)};r.src=n.src});return this}})(jQuery)